<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>aichat</title>
</head>
<body>
  <h2>AICHAT</h2>

  <label for="roleSelect">选择角色：</label>
  <select id="roleSelect">
    // 替换成选择的角色
    <option value="c1">角色 c1</option>
    <option value="c2">角色 c2</option>
    <option value="c3">角色 c3</option>
    <option value="c4">角色 c4</option>
    <option value="c5">角色 c5</option>
    <option value="c6">角色 c6</option>
  </select>

  <br><br>
  <button id="startBtn">开始录音</button>
  <button id="stopBtn" disabled>停止录音</button>
  <button id="playBtn" disabled>▶ 朗读角色回复</button>

  <h3>识别原文：</h3>
  <pre id="rawText"></pre>

  <h3>角色回复：</h3>
  <pre id="processedText"></pre>

  <script>
    let mediaRecorder;
    let audioChunks = [];

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const playBtn = document.getElementById("playBtn");

    startBtn.onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(audioChunks, { type: "audio/webm" });
        sendBlob(blob);
      };

      mediaRecorder.start();
      startBtn.disabled = true;
      stopBtn.disabled = false;
      playBtn.disabled = true;
    };

    stopBtn.onclick = () => {
      mediaRecorder.stop();
      startBtn.disabled = false;
      stopBtn.disabled = true;
    };

    async function sendBlob(blob) {
      const formData = new FormData();
      formData.append("audio", blob, "recording.webm");

      const role = document.getElementById("roleSelect").value;
      formData.append("role", role);

      const res = await fetch("/api/transcribe", {
        method: "POST",
        body: formData
      });

      const data = await res.json();

      document.getElementById("rawText").innerText = data.raw_text || "[无识别结果]";
      document.getElementById("processedText").innerText = data.processed_text || "[无回复]";

      playBtn.disabled = false; // 启用朗读按钮
    }

    playBtn.onclick = () => {
      // 加上时间戳，防止浏览器缓存播放旧音频
      const timestamp = Date.now();
      const audio = new Audio(`/api/tts_audio?ts=${timestamp}`);
      audio.play();
    };
  </script>
</body>
</html>
